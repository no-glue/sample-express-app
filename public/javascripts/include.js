var controlPanel=function(){var n=function(){var n=this;n.setEvents=function(e,t){return e||(e=_.extend),t||(t=Backbone.Events),n.events=e({},t),n},n.getEvents=function(){return"undefined"==typeof n.events&&n.setEvents(),n.events}};return new n}();
var Comment=Backbone.Model.extend({url:"/comments",idAttribute:"_id"});
var signedin=new TAFFY;
var Tip=Backbone.Model.extend({url:"/tips",idAttribute:"_id"});
var User=Backbone.Model.extend({url:"/users",idAttribute:"_id"});
var UserFetch=Backbone.Model.extend({url:function(){return"/users/single/"+this.email},set:function(e){for(var t in e)this[t]=e[t];return this},get:function(e){return this[e]}});
var CommentsCollection=Backbone.Collection.extend({model:Comment,url:"/comments",reset:function(e,o){return Backbone.Collection.prototype.reset.call(this,e,o)}});
var TipsCollection=Backbone.Collection.extend({model:Tip,url:"/tips",reset:function(e,o){return Backbone.Collection.prototype.reset.call(this,e,o)}});
var UsersCollection=Backbone.Collection.extend({model:User,url:"/users",reset:function(e,o){return Backbone.Collection.prototype.reset.call(this,e,o)}});
var View=Backbone.View.extend({set:function(r){for(var n in r)this[n]=r[n];return this},date:function(r){var n=r.toString().substring(0,8);return new Date(1e3*parseInt(n,16))},clear:function(){this.$el.html("")},unique:function(r,n){var e=r.toJSON(),t=_.property(n);return _.uniq(e,t)},formJson:function(r){for(var n={},e=0,t=r.length;t>e;e++){var i=r[e];n[i.name]=i.value}return n},trigger:function(r,n,e){e||(e=controlPanel),e.getEvents().trigger(r,n)},sortCid:function(r,n){return n||(n=1),_.sortBy(this.models,function(r){return n*parseInt(r.cid.substring(1,r.cid.length))})},sortCidReverse:function(r){return this.sortCid(r,-1)},markdown:function(r){return markdown.parse(r)},replace:function(r,n,e){var t={};return t=e?new RegExp("{{"+e+"}}","g"):new RegExp("{{(.*?)}}","g"),r.replace(t,n)},composite:function(r,n){for(var e in n){for(var t=n[e],i="",o=0,u=t.attributes.length;u>o;o++){var s=t.attributes[o];i+=r[s]}r[e]=i}return r},userSignedin:function(r){return r||(r=CookieJS),void 0!=r.get("user")},getUserSignedin:function(r){return r||(r=CookieJS),JSON.parse(r.get("user"))}});
var CommentView=View.extend({tagName:"div",className:"line margin-top-64px code",render:function(){var e=$("#commentTemplate").html();return this.$el.html(this.replace(e,this.markdown(this.model.attributes.content))),this}});
var CommentButtonView=View.extend({tagName:"span",className:"stripButton",render:function(){var t=$("#commentButtonTemplate").html(),e=Handlebars.compile(t);return this.$el.html(e(this.model.attributes)),this}});
var CommentButtonStripView=View.extend({tagName:"div",className:"line margin-top-64px",render:function(){var e=new CommentButtonView;return this.$el.html(e.set({model:this.model}).render().el),this}});
var CommentCreateFormView=View.extend({tagName:"form",className:"centre",events:{submit:"submit"},render:function(){var e=$("#commentCreateFormTemplate").html(),t=Handlebars.compile(e);return this.postId.userId=this.getUserSignedin()._id,this.$el.html(t(this.postId)),this},submit:function(e){e.preventDefault(),this.trigger("comment:create",this.formJson(this.$el.serializeArray()))}});
var CommentsView=View.extend({tagName:"div",className:"centre",render:function(){this.clear();var e=new LoggedinStripView;this.$el.append(e.render().el);for(var t=this.sortCidReverse(this.models),r=0,n=t.length;n>r;r++){var i=new CommentView;this.$el.append(i.set({model:t[r]}).render().el);var s=new CommentButtonStripView;this.$el.append(s.set({model:t[r]}).render().el)}return this}});
var LatestTipView=View.extend({tagName:"div",className:"centre",render:function(){this.clear();var e=this.collection.shift(),t=new LoginStripView;this.$el.append(t.render().el);var i=new LoggedinStripView;this.$el.append(i.render().el);var n=new LatestTipContentView;this.$el.append(n.set({model:e}).render().el);var r=new LatestTipTimeView;this.$el.append(r.set({model:e}).render().el);var a=new LatestTipButtonsView;this.$el.append(a.set({model:e}).render().el),this.collection.unshift(e);var s=new TagNamesView,l=this.unique(this.collection,"tag");this.$el.append(s.set({models:l}).render().el);var d=new TagCreateLinkView;return this.$el.append(d.render().el),this}});
var LatestTipButtonsView=View.extend({tagName:"div",className:"line margin-top-64px",render:function(){var e=new LatestTipTagView;this.$el.append(e.set({model:this.model}).render().el);var t=new LatestTipReportView;this.$el.append(t.set({model:this.model}).render().el);var i=new LatestTipSearchView;this.$el.append(i.set({model:this.model}).render().el);var s=new LatestTipCommentsView;return this.$el.append(s.set({model:this.model}).render().el),this}});
var LatestTipCommentsView=View.extend({tagName:"span",className:"stripButton",render:function(){var t=$("#latestTipCommentsTemplate").html(),e=Handlebars.compile(t),a=e(this.model.attributes);return this.$el.html(a),this}});
var LatestTipContentView=View.extend({tagName:"div",className:"line margin-top-64px code",render:function(){var t=$("#latestTipContentTemplate").html();return this.$el.html(this.replace(t,this.markdown(this.model.attributes.content))),this}});
var LatestTipReportView=View.extend({tagName:"span",className:"stripButton",events:{"click a":"report"},render:function(){var t=$("#latestTipReportTemplate").html();return this.$el.html(t),this.$el.attr("data-id",this.model.attributes._id),this},report:function(t){t.preventDefault(),this.trigger("tip:report",this.$el.attr("data-id"))}});
var LatestTipSearchView=View.extend({tagName:"span",className:"stripButton",render:function(){var t=$("#latestTipSearchTemplate").html();return this.$el.html(t),this.$el.attr("data-id",this.model.attributes._id),this}});
var LatestTipTagView=View.extend({tagName:"span",className:"stripButton",render:function(){var t=$("#latestTipTagTemplate").html(),e=Handlebars.compile(t),a=e(this.model.attributes);return this.$el.html(a),this}});
var LatestTipTimeView=View.extend({tagName:"div",className:"line margin-top-64px",render:function(){var e=$("#latestTipTimeTemplate").html(),t=Handlebars.compile(e),i=t({date:this.date(this.model.attributes._id)});return this.$el.html(i),this}});
var LoggedinStripView=View.extend({tagName:"div",className:"line margin-top-64px",events:{click:"signout"},render:function(){var e=$("#loggedinStripTemplate").html(),i=Handlebars.compile(e);return this.$el.html(this.userSignedin()?i(this.getUserSignedin()):""),this},signout:function(e){e.preventDefault(),this.trigger("user:signout")}});
var LoginFormView=View.extend({tagName:"form",events:{submit:"submit"},render:function(){var e=$("#loginFormTemplate").html();return this.$el.html(e),this},submit:function(e){e.preventDefault(),this.trigger("user:signin",this.formJson(this.$el.serializeArray()))}});
var LoginStripView=View.extend({tagName:"div",className:"line margin-top-64px",render:function(){var e=new LoginFormView;return this.$el.html(this.userSignedin()?"":e.render().el),this}});
var SearchView=View.extend({tagName:"div",render:function(){this.clear();var e=new SearchFieldView;this.$el.append(e.render().el);var r=new SearchResultsShowView;return this.$el.append(r.render().el),this}});
var SearchFieldView=View.extend({tagName:"form",events:{keyup:"keyup"},render:function(){var e=$("#searchFieldTemplate").html();return this.$el.html(e),this},keyup:function(){this.trigger("text:search",this.formJson(this.$el.serializeArray()))}});
var SearchResultsShowView=View.extend({tagName:"div",id:"searchResultsShow",render:function(){return this}});
var TagCreateFormView=View.extend({tagName:"form",className:"centre",events:{submit:"submit"},render:function(){return this.clear(),this.$el.html($("#tagCreateFormTemplate").html()),this},submit:function(t){t.preventDefault(),this.trigger("tag:create",this.composite(this.formJson(this.$el.serializeArray()),{text:{attributes:["tag","content"]}}))}});
var TagCreateLinkView=View.extend({tagName:"div",className:"centre margin-top-64px",render:function(){return this.clear(),this.$el.html($("#tagCreateLinkTemplate").html()),this}});
var TagNameView=View.extend({tagName:"li",className:"lineList",render:function(){var e=$("#latestTipTagTemplate").html(),a=Handlebars.compile(e),t=a(this.model);return this.$el.html(t),this}});
var TagNamesView=View.extend({tagName:"ul",className:"margin-top-64px",render:function(){return _.each(this.models,function(e){tagNameView=new TagNameView,this.$el.append(tagNameView.set({model:e}).render().el)},this),this}});
var TagTipsView=View.extend({tagName:"div",className:"centre",render:function(){this.clear();var e=new LoggedinStripView;this.$el.append(e.render().el);for(var r=this.sortCidReverse(this.models),i=0,t=r.length;t>i;i++){var n=new TipView;this.$el.append(n.set({model:r[i]}).render().el)}return this}});
var TipView=View.extend({tagName:"div",className:"centre",render:function(){this.clear();var e=new LatestTipContentView;this.$el.append(e.set({model:this.model}).render().el);var t=new LatestTipTimeView;this.$el.append(t.set({model:this.model}).render().el);var i=new LatestTipButtonsView;return this.$el.append(i.set({model:this.model}).render().el),this}});
var options=function(n){return n||(n={assure:assure,selector:$,navigate:function(n,t,e,r,a){if(e||(e="/"),t&&t.length){n+=e;for(var o=0,i=t.length;i>o;o++)n+=t[o]+e;n=n.substring(0,n.length-1)}r||(r=!0),a||(a=Backbone.history),a.navigate(n,r)},clearFragment:function(){Backbone.history.fragment=null}}),n};
var commentsControllerOptions=function(e){return e||(e={collection:new CommentsCollection,commentsView:new CommentsView,commentCreateFormView:new CommentCreateFormView,element:"#app"}),e};
var tipsControllerOptions=function(e){return e||(e={collection:new TipsCollection,latestTipView:new LatestTipView,tagTipsView:new TagTipsView,tagCreateFormView:new TagCreateFormView,searchView:new SearchView,element:"#app",elementSearchResultsShow:"#searchResultsShow"}),e};
var usersControllerOptions=function(e){return e||(e={collection:new UsersCollection,userFetch:new UserFetch,cookies:CookieJS,element:"#app"}),e};
var CommentsController=function(){var e=this;e.initialize=function(){return e.react("comment:create",e.created),e},e.set=function(t){for(var n in t)e[n]=t[n];return e},e.get=function(t){return e[t]},e.fetch=function(){var t=e.assure();return e.get("collection").fetch({reset:!0,success:function(e){t.resolve(e.lenght)}}),t},e.filter=function(t,n){return n||(n="text"),e.get("collection").filter(function(e){var o=e.get(n);return"undefined"==typeof o?!1:-1!==o.toLowerCase().indexOf(t.toLowerCase())})},e.saveModel=function(t,n){var o=e.get("collection").get(t),r=e.assure();return o.save(n,{wait:!0,success:function(e){r.resolve(e)}}),r},e.react=function(t,n,o,r){o||(o=e.get("root")),r||(r=controlPanel),r.getEvents().bind(t,n,o)},e.created=function(t){e.get("collection").create(t,{wait:!0,success:function(){e.navigate("tags",["comments",t.postId])}})},e.create=function(t){var n=e.fetch();n.then(function(){e.get("selector")(e.get("element")).html(e.get("commentCreateFormView").set({postId:{postId:t}}).render().el)})},e.comments=function(t){var n=e.get("collection").where({postId:t});if(n&&n.length)e.get("selector")(e.get("element")).html(e.get("commentsView").set({models:n}).render().el);else{var o=e.fetch();o.then(function(){var n=e.get("collection").where({postId:t});e.get("selector")(e.get("element")).html(e.get("commentsView").set({models:n}).render().el)})}}};
var TipsController=function(){var e=this;e.initialize=function(){return e.react("tag:create",e.created),e.react("tip:report",e.reported),e.react("text:search",e.searched),e},e.set=function(t){for(var n in t)e[n]=t[n];return e},e.get=function(t){return e[t]},e.fetch=function(){var t=e.assure();return e.get("collection").fetch({reset:!0,success:function(e){t.resolve(e.lenght)}}),t},e.filter=function(t,n){return n||(n="text"),e.get("collection").filter(function(e){var r=e.get(n);return"undefined"==typeof r?!1:-1!==r.toLowerCase().indexOf(t.toLowerCase())})},e.saveModel=function(t,n){var r=e.get("collection").get(t),c=e.assure();return r.save(n,{wait:!0,success:function(e){c.resolve(e)}}),c},e.react=function(t,n,r,c){r||(r=e.get("root")),c||(c=controlPanel),c.getEvents().bind(t,n,r)},e.created=function(t){e.get("collection").create(t,{wait:!0,success:function(){e.navigate("home")}})},e.reported=function(t){var n=e.saveModel(t,{reported:!0});n.then(function(){})},e.searched=function(t){e.get("selector")(e.get("elementSearchResultsShow")).html(e.get("tagTipsView").set({models:e.filter(t.search)}).render().el)},e.latestTip=function(){var t=e.fetch();t.then(function(){e.get("selector")(e.get("element")).html(e.get("latestTipView").set({collection:e.get("collection")}).render().el)})},e.create=function(){var t=e.fetch();t.then(function(){e.get("selector")(e.get("element")).html(e.get("tagCreateFormView").render().el)})},e.search=function(){var t=e.fetch();t.then(function(){e.get("selector")(e.get("element")).html(e.get("searchView").render().el)})},e.tag=function(t){var n=e.get("collection").where({tag:t});if(n&&n.length)e.get("selector")(e.get("element")).html(e.get("tagTipsView").set({models:n}).render().el);else{var r=e.fetch();r.then(function(){var n=e.get("collection").where({tag:t});e.get("selector")(e.get("element")).html(e.get("tagTipsView").set({models:n}).render().el)})}}};
var UsersController=function(){var e=this;e.initialize=function(){return e.react("user:signin",e.signedin),e.react("user:signout",e.signedout),e},e.set=function(t){for(var n in t)e[n]=t[n];return e},e.get=function(t){return e[t]},e.fetch=function(){var t=e.assure();return e.get("collection").fetch({reset:!0,success:function(e){t.resolve(e.lenght)}}),t},e.fetchUser=function(t){var n=e.assure();return e.get("userFetch").set({email:t}).fetch({success:function(e,t){n.resolve(t.pop())}}),n},e.react=function(t,n,o,i){o||(o=e.get("root")),i||(i=controlPanel),i.getEvents().bind(t,n,o)},e.cookie=function(e,t,n,o){return{name:e,value:t,expires:n?n:1,path:o?o:"/"}},e.signedin=function(t){var n=e.fetch();n.then(function(){var n=t.email+t.password,o=e.get("collection").where({password:n});if(o&&o.length)e.get("cookies").set(e.cookie("user",JSON.stringify(o.pop().toJSON()))),e.clearFragment(),e.navigate("home");else{var i=e.fetchUser(t.email);i.then(function(n){n?(e.get("cookies").set(e.cookie("user",JSON.stringify(n))),e.clearFragment(),e.navigate("home")):e.get("collection").create(t,{wait:!0,success:function(t){e.get("cookies").set(e.cookie("user",JSON.stringify(t.toJSON()))),e.clearFragment(),e.navigate("home")}})})}}),console.log("signedin>>>",t)},e.signedout=function(){e.get("cookies").delete({name:"user",path:"/"}),e.clearFragment(),e.navigate("home")}};
var Router=Backbone.Router.extend({initialize:function(t){_.extend(this,t)},routes:{"":"latestTip",home:"latestTip","tags/create":"create","tags/search":"search","tags/comments/create/:id":"commentsCreate","tags/comments/:id":"comments","tags/:tag":"tag"},latestTip:function(){this.controllers[this.urls.indexRoute].latestTip()},create:function(){this.controllers[this.urls.createRoute].create()},search:function(){this.controllers[this.urls.searchRoute].search()},tag:function(t){this.controllers[this.urls.tagRoute].tag(t)},comments:function(t){this.controllers[this.urls.commentsRoute].comments(t)},commentsCreate:function(t){this.controllers[this.urls.commentsCreateRoute].create(t)}});
!function(o){new Router(o);Backbone.history.start()}({urls:{indexRoute:"tipsController",createRoute:"tipsController",searchRoute:"tipsController",tagRoute:"tipsController",commentsCreateRoute:"commentsController",commentsRoute:"commentsController"},controllers:{tipsController:(new TipsController).set(_.extend(options(),tipsControllerOptions())).initialize(),commentsController:(new CommentsController).set(_.extend(options(),commentsControllerOptions())).initialize(),usersController:(new UsersController).set(_.extend(options(),usersControllerOptions())).initialize()}});